{% extends "admin/Common/iframe_common.html.twig" %}
{% block style %}
	<style>
	</style>
{% endblock %}
{% block container %}
    <div class="wrapper wrapper-content">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>{{lang("overview")}}</h5>
                    </div>
                    <div class="ibox-content container-fluid">
                    	<form action="">
	                        <div class="row">
	                        	<div class="col-md-3 form-group">
	                        		<label for="search-username">{{lang("start_date")}}</label>
	                        		<input type="text" class="form-control" readonly="readonly" id="start-date" name="name" value="">
	                        	</div>
	                        	<div class="col-md-3 form-group">
	                        		<label for="search-username">{{lang("end_date")}}</label>
	                        		<input type="text" class="form-control" readonly="readonly" id="end-date" name="name" value="">
	                        	</div>	                        	
	                            <div class="col-md-3 form-group">
	                            	<label for="null" class="center-block">&nbsp;</label>
	                            	<button type="button" class="btn btn-primary" id="search-btn"><i class="fa fa-search"></i>{{lang('search')}}</button>
	                            </div>
	                        </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="row chart-container">
        	<div class="col-sm-12">
        		<div class="col-sm-12">
		            <div class="ibox float-e-margins state-enable">
		                <div class="ibox-title clearfix">
		                    <div class="pull-right report-control btn-group">
			                    <label for="" style="float: left;line-height:2.5;margin-right: 5px;margin-left: 10px;">{{lang("dimensions")}}</label>
			                    <button data-type="nthDay" class="btn btn-white time-dimension btn-sm active">Daily</button>
								<button data-type="nthWeek" class="btn btn-white time-dimension btn-sm ">Weekly</button>
								<button data-type="nthMonth" class="btn btn-white time-dimension btn-sm ">Month</button>
		                    </div>		                    
		                    <div class="pull-right report-control">
			                    <label for="">{{lang("metrics")}}</label>
			                    <button data-type="users" class="btn btn-white report-dimension btn-sm active">{{lang("metric_users")}}</button>
			                    <button data-type="visits" class="btn btn-white report-dimension btn-sm active">{{lang('metric_visits')}}</button>
			                    <button data-type="pageviews" class="btn btn-white report-dimension btn-sm active">{{lang('metric_pageviews')}}</button>
			                    <button data-type="avgSessionDuration" class="btn btn-white report-dimension btn-sm active">{{lang('metric_avgDuration')}}</button>
		                    </div>
		                    <h5 style="line-height: 2"><i class="fa fa-line-chart"></i>{{lang("overview_charts")}}</h5>
		                </div>	            	
		            	<div class="ibox-content">
				            <div class="report-chart">
				                <div class="report-chart-content" id="report-line-chart" style="padding: 0px; position: relative;height:300px;width:100%;">
				                    
				                </div>
				            </div>        	
		            	</div>
	        		</div>
        			
        		</div>
<!--         		<div class="col-sm-4">
					<div class="ibox float-e-margins state-enable">
		                <div class="ibox-title clearfix">
		                    <h5><i class="fa fa-pie-chart"></i>Pie Charts</h5>
		                </div>	            	
		            	<div class="ibox-content">
				            <div class="report-chart">
				                <div class="report-chart-content" id="report-pie-chart" style="padding: 0px; position: relative;height:300px;width:100%;">
				                    
				                </div>
				            </div>        	
		            	</div>
	        		</div>        			
        		</div> -->

        	</div>
        </div>
		<div class="row">
			<div class="col-sm-12 container">
		        <div class="col-sm-2 static-item">
		            <div class="ibox float-e-margins state-enable">
		                <div class="ibox-title clearfix">
		                    <h5>{{lang('metric_sessions')}}</h5>
		                </div>
		                <div class="ibox-content">
		                    <h3 class="no-margins">
		                        <span class="metrics-text sessions-text">-</span>
		                    </h3>
		                </div>
		            </div>
		        </div> 
		        <div class="col-sm-2 static-item">
		            <div class="ibox float-e-margins state-enable">
		                <div class="ibox-title clearfix">
		                    <h5>{{lang("metric_users")}}</h5>
		                </div>
		                <div class="ibox-content">
		                    <h3 class="no-margins">
		                        <span class="metrics-text users-text">-</span>
		                    </h3>
		                </div>
		            </div>
		        </div> 
		        <div class="col-sm-2 static-item">
		            <div class="ibox float-e-margins state-enable">
		                <div class="ibox-title clearfix">
		                    <h5>{{lang('metric_pageviews')}}</h5>
		                </div>
		                <div class="ibox-content">
		                    <h3 class="no-margins">
		                        <span class="metrics-text pageviews-text">-</span>
		                    </h3>
		                </div>
		            </div>
		        </div> 	
		        <div class="col-sm-2 static-item">
		            <div class="ibox float-e-margins state-enable">
		                <div class="ibox-title clearfix">
		                    <h5>{{lang('metric_avgDuration')}}</h5>
		                </div>
		                <div class="ibox-content">
		                    <h3 class="no-margins">
		                        <span class="metrics-text avgSessionDuration-text">-</span>
		                    </h3>
		                </div>
		            </div>
		        </div> 			        	        							
				
			</div>
		</div>
		<div class="row">	
	        <div class="col-sm-12">
	    		<div class="col-sm-8">	

		            <div class="ibox float-e-margins state-enable">
		                <div class="ibox-title">
		                    <h5>{{lang('traffic_acquisition')}}</h5>
		                </div>
			           <div class="ibox-content container-fluid">	
		                    <div class="table-responsive col-md-12">
		                        <table class="table table-striped table-hover table-traffic">
		                            <thead>
		                                <tr>                                    
		                                    <th>Channel</th>
		                                    <th>Sessions</th>
		                                    <th>New User</th>
		                                    <th>Bounce Rate</th>
		                                    <th>Pageviews Per Session</th>
		                                </tr>
		                            </thead>
		                            <tbody>

		                            </tbody>
		                        </table>
		                    </div>
			           </div>
		           </div>
				</div>
        		<div class="col-sm-4">
					<div class="ibox float-e-margins state-enable">
		                <div class="ibox-title clearfix">
		                    <h5><i class="fa fa-pie-chart"></i>Pie Charts</h5>
		                </div>	            	
		            	<div class="ibox-content">
				            <div class="report-chart">
				                <div class="report-chart-content" id="traffic-pie-chart" style="padding: 0px; position: relative;height:192px;width:100%;">
				                    
				                </div>
				            </div>        	
		            	</div>
	        		</div>        			
        		</div>				
			</div>
		</div>
		<div class="row">	
	        <div class="col-sm-12">
	    		<div class="col-sm-6">	

		            <div class="ibox float-e-margins state-enable">
		                <div class="ibox-title">
		                    <h5>{{lang('landingPage')}}</h5>
		                </div>
			           <div class="ibox-content container-fluid">	
		                    <div class="table-responsive col-md-12">
		                        <table class="table table-striped table-hover table-landingPage">
		                            <thead>
		                                <tr>                                    
		                                    <th>{{lang('metric_channels')}}</th>
		                                    <th>{{lang('metric_sessions')}}</th>
		                                    <th>{{lang('metric_pvPerSession')}}</th>
		                                </tr>
		                            </thead>
		                            <tbody>

		                            </tbody>
		                        </table>
		                    </div>
			           </div>
		           </div>
				</div>		
	    		<div class="col-sm-6">	

		            <div class="ibox float-e-margins state-enable">
		                <div class="ibox-title">
		                    <h5>{{lang('secondPage')}}</h5>
		                </div>
			           <div class="ibox-content container-fluid">	
		                    <div class="table-responsive col-md-12">
		                        <table class="table table-striped table-hover table-secondPage">
		                            <thead>
		                                <tr>                                    
		                                    <th>{{lang('metric_channels')}}</th>
		                                    <th>{{lang('metric_sessions')}}</th>
		                                    <th>{{lang('metric_pvPerSession')}}</th>
		                                </tr>
		                            </thead>
		                            <tbody>

		                            </tbody>
		                        </table>
		                    </div>
			           </div>
		           </div>
				</div>						
			</div>
		</div>		
    </div>
{% endblock %}
{% block script %}
<script src="{{base_url('public/admin/js/plugins/echarts/echarts.js')}}"></script>
<script src="{{base_url('public/admin/js/plugins/layer/laydate/laydate.js')}}"></script>    
<script src="{{base_url('public/admin/js/report.js')}}"></script>
<script>
	jQuery(document).ready(function($) {
		var initDate = common.getDate("last-7-days")
			,rangeDate = []
			,rangeDays = []
		$("#start-date").val(initDate[0]);
		$("#end-date").val(initDate[1]);
		$('#search-btn').on('click', function(event) {
			event.preventDefault();
			var range = $("#start-date").val()+"/"+$("#end-date").val();
	        common.getMetrics({
	        	url:"{{base_url('admin/Ga/getMetrics')}}",
	        	metrics:[
	        		"users","visits","pageviews","newVisits","sessions","avgSessionDuration"
	        	],
	        	range:range
	        },initMetrics)
	        common.getChart({
	        	url:"{{base_url('admin/Ga/getChart')}}",
	        	dimensions:[
	        		$(".time-dimension.active").data("type")
	        	],
	        	metrics:[
	        		"users","visits","pageviews","avgSessionDuration"
	        	],
	        	range:range
	        },initChart)
	        common.getChart({
	        	url:"{{base_url('admin/Ga/getChart')}}",
	        	dimensions:[
	        		"channelGrouping"
	        	],
	        	orderType:"VALUE",
	        	fieldName:"sessions",
	        	sortOrder:"desc",	        	
	        	metrics:[
	        		"sessions","newUsers","bounceRate","pageviewsPerSession"
	        	],
	        	range:range
	        },function(e){
	        	initTable(e,".table-traffic")
	        })
	        common.getChart({
	        	url:"{{base_url('admin/Ga/getChart')}}",
	        	dimensions:[
	        		"landingPagePath"
	        	],
	        	orderType:"VALUE",
	        	fieldName:"sessions",
	        	sortOrder:"desc",	        	
	        	metrics:[
	        		"sessions","pageviewsPerSession"
	        	],
	        	range:range
	        },function(e){
	        	initTable(e,".table-landingPage")
	        })
	        common.getChart({
	        	url:"{{base_url('admin/Ga/getChart')}}",
	        	orderType:"VALUE",
	        	fieldName:"sessions",
	        	sortOrder:"desc",
	        	dimensions:[
	        		"secondPagePath"
	        	],
	        	metrics:[
	        		"sessions","pageviewsPerSession"
	        	],
	        	range:range
	        },function(e){
	        	initTable(e,".table-secondPage")
	        })	        	        	        
	        rangeDays = []
        	var startStamp = new Date($("#start-date").val()).getTime()
	        	,endStamp = new Date($("#end-date").val()).getTime();
	        do{
	        	rangeDays.push((new Date(startStamp).Format()));
	        	startStamp += 24*1000*3600
	        }while(startStamp<=endStamp)//生成时间数组
		}).click();
        function initMetrics(data){ 	
        	$('.metrics-text').text("-")
	        if(data.length){
	        	for(var i in data){
	        		var item = data[i];
	        		var dom = $("."+item.name+"-text");
	        		var text = "";
	        		switch (item.type){
	        			case "INTEGER":
	        			case "STRING":
	        				text = item.value;
	        				break; 
	        			case "TIME":
	        				text = Number(item.value).toFixed(3)+" Sec";
	        				break;
	        			case "PERCENT":
	        				text = Number(item.value).toFixed(2)+"%";
	        				break;
	        			case "CURRENCY":
	        				text = item.value+" $";
	        				break;
	        			default:
	        				text = item.value;
	        				break;
	        		}
	        		dom.text(text)
	        	}
	        }
        }
		var lineChart = echarts.init(document.querySelector('#report-line-chart'));
        function initChart(data){
	        // 指定图表的配置项和数据
	        var len = data.length;
	        var legend = {};
	        var xAxis= [];
	        for(var i = 0;i<len;i++){
	        	var row = data[i].row
	        	var key = data[i].rowKey
	        	for(var item in row){
	        		if(legend.hasOwnProperty(row[item].name)){
	        			legend[row[item].name].push(row[item].value)
	        		}else{
	        			legend[row[item].name] = [];
	        			legend[row[item].name].push(row[item].value)
	        		}
	        	}
	        	for(var item in key){
	        		xAxis.push(rangeDays[Number(key[item].displayname)])
	        	}
	        }
	        var legendName = [];
	        for(var i in legend){
	        	legendName.push(i)
	        }
			var lineOption = {
			    title: {
			        text: 'Basic Data Line'
			    },
			    tooltip : {
			        trigger: 'axis',
			    },
			    legend: {
			        data:legendName,
			        show:true,
			        selectedMode:false
			    },
			    toolbox: {
			        feature: {
			            saveAsImage: {}
			        }
			    },
			    grid: {
			        left: '3%',
			        right: '4%',
			        bottom: '3%',
			        containLabel: true
			    },
			    xAxis : [
			        {
			            type : 'category',
			            boundaryGap : false,
			            data : xAxis,
			            splitLine: {
			                show: false
			            }
			        },

			    ],
			    yAxis : [
			        {	
			        	name:"",
			            type : 'value',
			            position:'left',
			            splitLine: {
			                show: false
			            }
			        },
			        {
			        	name:'Seconds',
			        	type:"value",
			        	position:"right",
			            splitLine: {
			                show: false
			            }
			        }
			    ],
			    series : [
			        {
			            name:'users',
			            type:'line',
			            areaStyle:{normal:{}},
			            data:legend.users
			        },
			        {
			            name:'visits',
			            type:'line',
			            areaStyle:{normal:{}},		            
			            data:legend.visits
			        },
			        {
			            name:'pageviews',
			            type:'line',
			            areaStyle:{normal:{}},
			            data:legend.pageviews
			        },
			        {
			            name:'avgSessionDuration',
			            type:'line',
			            areaStyle:{normal:{}},			            
			            data:legend.avgSessionDuration,
			            yAxisIndex:1
			        },
			    ]
			};
	        lineChart.setOption(lineOption);        	
        }
        function initTable(datas,ele){
        	var dom = [];
        	for(var data in datas ){
        	var key = datas[data].rowKey
        		,row = datas[data].row;
	        	for(var i = 0;i<key.length;i++){
	        		var tds = "";
	        		for(var j in row){
	        			switch(row[j].name){
	        				case "bounceRate":
			        			tds+='<td>'+Number(row[j].value).toFixed(2)+'%</td>'
			        			break;
			        		case "pageviewsPerSession":
			        			tds+='<td>'+Number(row[j].value).toFixed(2)+'</td>'
			        			break;
	        				case "sessions":
	        				case "newUsers":
	        				default:
			        			tds+='<td>'+row[j].value+'</td>'
			        			break;
	        				
	        			}
	        		}
	        		dom.push('<tr><td>'+key[i].displayname+'</td>'+tds+'</tr>')
	        	}
        	}
        	console.log(ele,$(ele))
        	$(ele).find("tbody").empty().append(dom.join(""))
        }
        $(document).on('click', '.report-control .report-dimension', function(event) {
        	$(this).toggleClass('active');
        	var name = $(this).data("type")
        	var type = $(this).hasClass('active')?'legendSelect':"legendUnSelect";
        	lineChart.dispatchAction({
			    type: type,
			    name: name
			})
        });
        $(document).on('click', '.report-control .time-dimension', function(event) {
			var range = $("#start-date").val()+"/"+$("#end-date").val();

        	var name = $(this).data("type")
	        // common.getChart({
	        // 	url:"{{base_url('admin/Ga/getChart')}}",
	        // 	dimensions:[
	        // 		name
	        // 	],
	        // 	metrics:[
	        // 		"users","visits","pageviews","avgSessionDuration"
	        // 	],
	        // 	range:range
	        // },initChart)
        });        
		var start = {
		    elem: '#start-date',
		    format: 'YYYY-MM-DD',
			max: '2099-06-16 23:59:59', //最大日期
		    istime: false,
		    istoday: false,
		    choose: function(datas){
		         end.min = datas; //开始日选好后，重置结束日的最小日期
		         end.start = datas //将结束日的初始值设定为开始日
		    }
		}
		,end = {
		    elem: '#end-date',
		    format: 'YYYY-MM-DD',
		    max: '2099-06-16 23:59:59',
		    istime: false,
		    istoday: false,
		    choose: function(datas){
		        start.max = datas; //结束日选好后，重置开始日的最大日期
		    }
		};
		laydate(start)
		laydate(end)
	});

</script>
{% endblock %}